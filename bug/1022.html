<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                      "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en">
  <head>
    <title>Bug 1022 &ndash; Orphan windows when Quit was cancelled</title>

      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">


<link rel="Top" href="">

  


  
    
      

      
      



    
    <link href="../css/global.css"
          rel="alternate stylesheet" 
          title="Classic"><link href="../css/global.css" rel="stylesheet"
        type="text/css" ><link href="../css/bug.css" rel="stylesheet"
        type="text/css" >

    <link href="../css/dusk.css" rel="stylesheet"
        type="text/css" title="Dusk">

    

    

    


    


    

    
    
    
  </head>



  <body onload=""
        class=" bz_bug bz_status_RESOLVED bz_product_Fiji bz_component_Other bz_bug_1022 yui-skin-sam">



<div id="header">
<div id="banner">
  </div>

<table border="0" cellspacing="0" cellpadding="0" id="titles">
<tr>
    <td id="title">
      <p>Bugzilla &ndash; Bug&nbsp;1022</p>
    </td>

    <td id="subtitle">
      <p class="subheader">Orphan windows when Quit was cancelled</p>
    </td>

    <td id="information">
      <p class="header_addl_info">Last modified: 2015-04-21 11:40:28 CDT</p>
    </td>
</tr>
</table>


</div> 

<div id="notice">
  <table>
    <tr>
      <td style="font-size: 72px; color: firebrick; padding: 0 10px 0 10px">&#9888;</td>
      <td>
        <p style="margin: 0.4em">
        NOTICE! This is a static HTML version of a legacy Fiji BugZilla bug.
        </p>
        <p style="margin: 0.4em">
        The Fiji project now
        <a href="https://imagej.net/Issues">uses GitHub Issues</a> for issue tracking.
        </p>
        <p style="margin: 0.4em">
        Please
        <a href="https://github.com/fiji/fiji/issues/new">file all new issues</a>
        there.
        </p>
      </td>
    </tr>
  </table>
</div>

<div id="bugzilla-body">


<div class="bz_alias_short_desc_container edit_form">
     <a href="1022.html"><b>Bug&nbsp;1022</b></a> -<span id="summary_alias_container" class="bz_default_hidden"> 
      <span id="short_desc_nonedit_display">Orphan windows when Quit was cancelled</span>
     </span>
  
       
    <div id="summary_alias_input">
      <table id="summary"> 
        <tr>
            <td colspan="2">
          </td>
        </tr>
        
        <tr><th class="field_label "
    id="field_label_short_desc">

    <label for="short_desc" accesskey="s">

  <a 
      title="The bug summary is a short sentence which succinctly describes what the bug is about."
      class="field_help_link"
  >Summary:</a>
</label>
</th>
          <td>Orphan windows when Quit was cancelled
          </td>
        </tr>
      </table>
    </div>
  </div>
  
  <table class="edit_form">
    <tr>
      
      <td id="bz_show_bug_column_1" class="bz_show_bug_column">     
        <table>
          <tr>
    <th class="field_label">
      <a>Status</a>:
    </th>
    <td id="bz_field_status">
      <span id="static_bug_status">RESOLVED
          FIXED
      </span>
    </td>
  </tr>
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
          <tr><th class="field_label "
    id="field_label_product">


  <a 
      title="Bugs are categorised into Products and Components."
      class="field_help_link"
  >Product:</a>

</th>
  <td class="field_value "
      id="field_container_product" >Fiji</td>
    </tr>

    
    <tr class="bz_default_hidden"><th class="field_label "
    id="field_label_classification">


  <a 
      title="Bugs are categorised into Classifications, Products and Components. classifications is the top-level categorisation."
      class="field_help_link"
  >Classification:</a>

</th>
  <td class="field_value "
      id="field_container_classification" >Unclassified</td>
    </tr>
        
    
    
    <tr><th class="field_label "
    id="field_label_component">


  <a 
      title="Components are second-level categories; each belongs to a particular Product. Select a Product to narrow down this list."
      class="field_help_link"
  >Component:</a>

</th>
  <td class="field_value "
      id="field_container_component" >Other</td>
    </tr>
    <tr><th class="field_label "
    id="field_label_version">

    <label for="version">

  <a 
      title="The version field defines the version of the software the bug was found in."
      class="field_help_link"
  >Version:</a>
</label>
</th>
        <td>unspecified
  </td>
    </tr>
        
    
        
    <tr><th class="field_label "
    id="field_label_rep_platform">

    <label for="rep_platform" accesskey="h">

  <a 
      title="The hardware platform the bug was observed on. Note: When searching, selecting the option &quot;All&quot; only finds bugs whose value for this field is literally the word &quot;All&quot;."
      class="field_help_link"
  >Hardware:</a>
</label>
</th>
      <td class="field_value">PC
       Windows
      </td>
    </tr>
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
          
          <tr>
      <th class="field_label">
        <label for="priority" accesskey="i">
          <a><u>I</u>mportance</a></label>:
      </th>
      <td>P5
       normal
      </td>
    </tr>            
          
          <tr>
      <th class="field_label">
        <a>Assigned To</a>:
      </th>
      <td><span class="vcard"><span class="fn">ImageJ Bugs Mailing List</span>
</span>
      </td>
    </tr>

    
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
          <tr><th class="field_label "
    id="field_label_bug_file_loc">

    <label for="bug_file_loc" accesskey="u">

  <a 
      title="Bugs can have a URL associated with them - for example, a pointer to a web site where the problem is seen."
      class="field_help_link"
  >URL:</a>
</label>
</th>
    <td>
      <span id="bz_url_input_area">
      </span>
    </td>
  </tr>
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>

          
<tr><th class="field_label "
    id="field_label_dependson">


  <a 
      title="The bugs listed here must be resolved before this bug can be resolved."
      class="field_help_link"
  >Depends on:</a>

</th>

  <td>
    <span id="dependson_input_area">
    </span>
    
  </td>
  </tr>
  
  <tr><th class="field_label "
    id="field_label_blocked">


  <a 
      title="This bug must be resolved before the bugs listed in this field can be resolved."
      class="field_help_link"
  >Blocks:</a>

</th>

  <td>
    <span id="blocked_input_area">
    </span>
    
  </td>
  </tr>
        </table>
      </td>
      <td>
        <div class="bz_column_spacer">&nbsp;</div>
      </td>
      
      <td id="bz_show_bug_column_2" class="bz_show_bug_column">
        <table cellpadding="3" cellspacing="1">
        <tr>
    <th class="field_label">
      Reported:
    </th>
    <td>2015-03-11 09:17 CDT by <span class="vcard"><span class="fn">Jan Eglinger</span>
</span>
    </td>
  </tr>
  
  <tr>
    <th class="field_label">
      Modified:
    </th>
    <td>2015-04-21 11:40 CDT 
    </td>
  
  </tr>
         <tr>
      <th class="field_label">
        <label for="newcc" accesskey="a">CC List:</label>
      </th>
      <td>3 
          users
          <span id="cc_edit_area_showhide_container" class="bz_default_hidden">
            (<a href="#" id="cc_edit_area_showhide">show</a>)
          </span>
        <div id="cc_edit_area">
          <br>
            <select id="cc" multiple="multiple" size="5">
                <option value="ctrueden">ctrueden</option>
                <option value="hinerm">hinerm</option>
                <option value="wsr">wsr</option>
            </select>
        </div>
          
      </td>
    </tr>
         <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
<tr><th class="field_label "
    id="field_label_see_also">


  <a 
      title="This allows you to refer to bugs in other installations. You can enter a URL to a bug in the 'Add Bug URLs' field to note that that bug is related to this one. You can enter multiple URLs at once by separating them with a comma. You should normally use this field to refer to bugs in other installations. For bugs in this installation, it is better to use the Depends on and Blocks fields."
      class="field_help_link"
  >See Also:</a>

</th>
  <td class="field_value "
      id="field_container_see_also" ></td>
    </tr> 
         
         <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
         
                

        </table>
      </td>
    </tr>
    <tr>
      <td colspan="3">
          <hr id="bz_top_half_spacer">
      </td>
    </tr>
  </table>

  <table id="bz_big_form_parts" cellspacing="0" cellpadding="0"><tr>
  <td>

    



  </td>
  <td>
  </td>
  </tr></table>

  
  <div id="comments">






<!-- This auto-sizes the comments and positions the collapse/expand links 
     to the right. -->
<table class="bz_comment_table" cellpadding="0" cellspacing="0"><tr>
<td>
<div id="c0" class="bz_comment bz_first_comment">

      <div class="bz_first_comment_head">



        <span class="bz_comment_number">
          <a 
             href="#c0">Description</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Jan Eglinger</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2015-03-11 09:17:49 CDT
        </span>
      </div>



<pre class="bz_comment_text" >When you quit Fiji while there are unsaved images, a dialog will ask whether to save changes for each modified image. After cancelling one of the dialogs, the corresponding image window remains open but is inaccessible via the Window menu, and cannot be closed by its window's close button.

To reproduce, you can use the following macro code. Run it and press Cancel in the first dialog. A blobs.gif window will remain open, but there's no blobs.gif entry in the Window menu, and you cannot close the window. Running File&gt;Close will result in a message &quot;There are no images open.&quot;

  run(&quot;Blobs (25K)&quot;);
  run(&quot;Invert&quot;);
  run(&quot;Blobs (25K)&quot;);
  run(&quot;Invert&quot;);
  run(&quot;Quit&quot;);
  selectWindow(&quot;blobs-1.gif&quot;);
  close();



Information about your version of Java:

  os.arch =&gt; amd64
  os.name =&gt; Windows 7
  os.version =&gt; 6.1
  java.version =&gt; 1.6.0_24
  java.vendor =&gt; Sun Microsystems Inc.
  java.runtime.name =&gt; Java(TM) SE Runtime Environment
  java.runtime.version =&gt; 1.6.0_24-b07
  java.vm.name =&gt; Java HotSpot(TM) 64-Bit Server VM
  java.vm.version =&gt; 19.1-b02
  java.vm.vendor =&gt; Sun Microsystems Inc.
  java.vm.info =&gt; mixed mode
  java.awt.graphicsenv =&gt; sun.awt.Win32GraphicsEnvironment
  java.specification.name =&gt; Java Platform API Specification
  java.specification.version =&gt; 1.6
  sun.cpu.endian =&gt; little
  sun.desktop =&gt; windows
  file.separator =&gt; \

The up-to-date check says: REMIND_LATER

Information relevant to JAVA_HOME related problems:

  JAVA_HOME is set to: C:\UTILIT~1\FIJI-D~1.APP/java/win64/jdk1.6.0_24//jre
  imagej.dir =&gt; C:\UTILIT~1\FIJI-D~1.APP

Information about the version of each plugin:

Activated update sites:
ImageJ: <a href="http://update.imagej.net/">http://update.imagej.net/</a> (last check:20150309141004)
Fiji: <a href="http://fiji.sc/update/">http://fiji.sc/update/</a> (last check:20150310172923)</pre>
    </div><div id="c1" class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a 
             href="#c1">Comment 1</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Mark Hiner</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2015-03-11 09:32:28 CDT
        </span>
      </div>



<pre class="bz_comment_text" >Confirmed. Also happens in a fresh ImageJ 1.49p. Thanks for the great report Jan!</pre>
    </div><div id="c2" class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a 
             href="#c2">Comment 2</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Wayne Rasband</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2015-03-11 19:19:28 CDT
        </span>
      </div>



<pre class="bz_comment_text" >This bug is fixed in the latest ImageJ daily build (1.49q5). The ImageWindow.close() method displayed a &quot;save changes?&quot; dialog because IJ.macroRunning() returned false. It returned false because the 'quit' code in ImageJ runs on a separate thread. The daily build works around this problem by adding a quittingViaMacro() method that the close() method queries.</pre>
    </div><div id="c3" class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a 
             href="#c3">Comment 3</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Jan Eglinger</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2015-03-12 03:02:06 CDT
        </span>
      </div>



<pre class="bz_comment_text" >Hi Wayne,

sorry, this doesn't fix the bug for me:

with ImageJ v1.49q5 (in Fiji), there are now *two* orphan windows after I cancel the &quot;save changes&quot; dialog (an additional error appears: No window with the title &quot;blobs-1.gif&quot; found.).
Moreover, when I click on &quot;No&quot; to discard changes, ImageJ does not ask to save the changes in the second unsaved image (it did so before).

Please notice that the bug I reported is not limited to the use of the macro language, it appears when quitting via File&gt;Quit or when closing the Fiji main window.

In summary, the changes in 1.49q5 make it even worse for me.

Jan</pre>
    </div><div id="c4" class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a 
             href="#c4">Comment 4</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Wayne Rasband</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2015-03-12 10:49:59 CDT
        </span>
      </div>



<pre class="bz_comment_text" >Hi Jan,

This seems to be a problem with the Fiji Script Editor. Your test macro works as expected with v1.49q5 if I run it in Fiji using the Plugins&gt;Macros&gt;Run command, or if I run it by pasting it into Fiji (where it opens in the ImageJ macro editor) or if I run it in ImageJ. I also do not see a problem if I exit Fiji by using the File&gt;Quit command or by closing the main Fiji window. I do see the problem if I run the test macro in the Script Editor and click &quot;Cancel&quot; in the &quot;Select an Option&quot; dialog displayed by the Script Editor.</pre>
    </div><div id="c5" class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a 
             href="#c5">Comment 5</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Jan Eglinger</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2015-03-12 11:15:34 CDT
        </span>
      </div>



<pre class="bz_comment_text" >Apparently our expectations differ then :)

I just ran the test macro by copying the code and then opening it in the macro editor by File&gt;New&gt;System Clipboard
Running the macro like this (with ImageJ 1.49q5) results in Fiji quitting without *any* dialog. I would have expected a dialog for each image that contains unsaved changes.

Anyhow, I can confirm that the behaviour is Fiji- (or Script editor-)related now, because in plain ImageJ the macro works as you describe (although I would expect dialogs if there are unsaved changes, even when the quit command was issued from a macro).</pre>
    </div><div id="c6" class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a 
             href="#c6">Comment 6</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Wayne Rasband</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2015-03-12 12:11:23 CDT
        </span>
      </div>



<pre class="bz_comment_text" >Macro functions that close image windows (e.g., close(), run(&quot;Close&quot;), run(&quot;Close All&quot;) and run(&quot;Quit&quot;)) do not display &quot;save changes&quot; dialogs. Here is a version of the test macro that displays a dialog before calling run(&quot;Quit&quot;):

  run(&quot;Blobs (25K)&quot;);
  run(&quot;Invert&quot;);
  run(&quot;Blobs (25K)&quot;);
  run(&quot;Invert&quot;);
  n = 0;
  for (i=1; i&lt;=nImages; i++) {
     selectImage(i);
     if (is(&quot;changes&quot;)) n++;
  }
  if (n&gt;0) {
     msg = &quot;There are &quot;+n+&quot; images with changes&quot;;
     showMessageWithCancel(&quot;Quit?&quot;, msg);
  }
  run(&quot;Quit&quot;);
  selectWindow(&quot;blobs-1.gif&quot;);
  close();</pre>
    </div><div id="c7" class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a 
             href="#c7">Comment 7</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Mark Hiner</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2015-03-13 09:02:12 CDT
        </span>
      </div>



<pre class="bz_comment_text" > Jan - the original cause for bug report is that ImageWindows do not get disposed when they are closed during a potential quit operation[1].

 Fiji makes some significant changes to what ImageJ does when it quits, which Curtis discussed in a news post[2].

 So on the Fiji side we have to take some extra precautions when images are closed to ensure they are disposed, so things don't get out of synch in the event of a subsequent cancel[3, 4].

 Note that these patches won't affect the ImageJ 1.49q5 behavior when closing from a macro. That is a separate issue[5], but something we should be able to easily accommodate when we upgrade to 1.49q.

Thanks again!

[1] <a href="https://github.com/imagej/ImageJA/blob/v1.49p/src/main/java/ij/gui/ImageWindow.java#L401-403">https://github.com/imagej/ImageJA/blob/v1.49p/src/main/java/ij/gui/ImageWindow.java#L401-403</a>

[2] <a href="http://imagej.net/2014-07-11_-_Fiji_won%27t_quit">http://imagej.net/2014-07-11_-_Fiji_won%27t_quit</a>!

[3] <a href="https://github.com/imagej/ij1-patcher/commit/1eef7e2e7b3b41df66ba90a09849e793ef180eb4">https://github.com/imagej/ij1-patcher/commit/1eef7e2e7b3b41df66ba90a09849e793ef180eb4</a>

[4] <a href="https://github.com/imagej/imagej-legacy/commit/5b7185b228feedf69c516f31124cfe0e6f17d709">https://github.com/imagej/imagej-legacy/commit/5b7185b228feedf69c516f31124cfe0e6f17d709</a>

[5] <a href="https://github.com/imagej/ij1-patcher/issues/34">https://github.com/imagej/ij1-patcher/issues/34</a></pre>
    </div><div id="c8" class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a 
             href="#c8">Comment 8</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Curtis Rueden</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2015-04-21 11:40:28 CDT
        </span>
      </div>



<pre class="bz_comment_text" >Presumed fixed. Please reopen if not.</pre>
    </div>


  

</td>
<td>
</td>
</tr></table>
  </div>
        



</div>

</body>
</html>
