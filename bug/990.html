<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                      "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en">
  <head>
    <title>Bug 990 &ndash; Mac OS out of memory</title>

      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">


<link rel="Top" href="">

  


  
    
      

      
      



    
    <link href="../css/global.css"
          rel="alternate stylesheet" 
          title="Classic"><link href="../css/global.css" rel="stylesheet"
        type="text/css" ><link href="../css/bug.css" rel="stylesheet"
        type="text/css" >

    <link href="../css/dusk.css" rel="stylesheet"
        type="text/css" title="Dusk">

    

    

    


    


    

    
    
    
  </head>



  <body onload=""
        class=" bz_bug bz_status_RESOLVED bz_product_Fiji bz_component_Plugins bz_bug_990 yui-skin-sam">



<div id="header">
<div id="banner">
  </div>

<table border="0" cellspacing="0" cellpadding="0" id="titles">
<tr>
    <td id="title">
      <p>Bugzilla &ndash; Bug&nbsp;990</p>
    </td>

    <td id="subtitle">
      <p class="subheader">Mac OS out of memory</p>
    </td>

    <td id="information">
      <p class="header_addl_info">Last modified: 2015-02-18 12:20:38 CST</p>
    </td>
</tr>
</table>


</div> 

<div id="notice">
  <table>
    <tr>
      <td style="font-size: 72px; color: firebrick; padding: 0 10px 0 10px">&#9888;</td>
      <td>
        <p style="margin: 0.4em">
        NOTICE! This is a static HTML version of a legacy Fiji BugZilla bug.
        </p>
        <p style="margin: 0.4em">
        The Fiji project now
        <a href="https://imagej.net/Issues">uses GitHub Issues</a> for issue tracking.
        </p>
        <p style="margin: 0.4em">
        Please
        <a href="https://github.com/fiji/fiji/issues/new">file all new issues</a>
        there.
        </p>
      </td>
    </tr>
  </table>
</div>

<div id="bugzilla-body">


<div class="bz_alias_short_desc_container edit_form">
     <a href="990.html"><b>Bug&nbsp;990</b></a> -<span id="summary_alias_container" class="bz_default_hidden"> 
      <span id="short_desc_nonedit_display">Mac OS out of memory</span>
     </span>
  
       
    <div id="summary_alias_input">
      <table id="summary"> 
        <tr>
            <td colspan="2">
          </td>
        </tr>
        
        <tr><th class="field_label "
    id="field_label_short_desc">

    <label for="short_desc" accesskey="s">

  <a 
      title="The bug summary is a short sentence which succinctly describes what the bug is about."
      class="field_help_link"
  >Summary:</a>
</label>
</th>
          <td>Mac OS out of memory
          </td>
        </tr>
      </table>
    </div>
  </div>
  
  <table class="edit_form">
    <tr>
      
      <td id="bz_show_bug_column_1" class="bz_show_bug_column">     
        <table>
          <tr>
    <th class="field_label">
      <a>Status</a>:
    </th>
    <td id="bz_field_status">
      <span id="static_bug_status">RESOLVED
          FIXED
      </span>
    </td>
  </tr>
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
          <tr><th class="field_label "
    id="field_label_product">


  <a 
      title="Bugs are categorised into Products and Components."
      class="field_help_link"
  >Product:</a>

</th>
  <td class="field_value "
      id="field_container_product" >Fiji</td>
    </tr>

    
    <tr class="bz_default_hidden"><th class="field_label "
    id="field_label_classification">


  <a 
      title="Bugs are categorised into Classifications, Products and Components. classifications is the top-level categorisation."
      class="field_help_link"
  >Classification:</a>

</th>
  <td class="field_value "
      id="field_container_classification" >Unclassified</td>
    </tr>
        
    
    
    <tr><th class="field_label "
    id="field_label_component">


  <a 
      title="Components are second-level categories; each belongs to a particular Product. Select a Product to narrow down this list."
      class="field_help_link"
  >Component:</a>

</th>
  <td class="field_value "
      id="field_container_component" >Plugins</td>
    </tr>
    <tr><th class="field_label "
    id="field_label_version">

    <label for="version">

  <a 
      title="The version field defines the version of the software the bug was found in."
      class="field_help_link"
  >Version:</a>
</label>
</th>
        <td>unspecified
  </td>
    </tr>
        
    
        
    <tr><th class="field_label "
    id="field_label_rep_platform">

    <label for="rep_platform" accesskey="h">

  <a 
      title="The hardware platform the bug was observed on. Note: When searching, selecting the option &quot;All&quot; only finds bugs whose value for this field is literally the word &quot;All&quot;."
      class="field_help_link"
  >Hardware:</a>
</label>
</th>
      <td class="field_value">Macintosh
       Mac OS
      </td>
    </tr>
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
          
          <tr>
      <th class="field_label">
        <label for="priority" accesskey="i">
          <a><u>I</u>mportance</a></label>:
      </th>
      <td>P4
       normal
      </td>
    </tr>            
          
          <tr>
      <th class="field_label">
        <a>Assigned To</a>:
      </th>
      <td><span class="vcard"><span class="fn">ImageJ Bugs Mailing List</span>
</span>
      </td>
    </tr>

    
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
          <tr><th class="field_label "
    id="field_label_bug_file_loc">

    <label for="bug_file_loc" accesskey="u">

  <a 
      title="Bugs can have a URL associated with them - for example, a pointer to a web site where the problem is seen."
      class="field_help_link"
  >URL:</a>
</label>
</th>
    <td>
      <span id="bz_url_input_area">
      </span>
    </td>
  </tr>
          <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>

          
<tr><th class="field_label "
    id="field_label_dependson">


  <a 
      title="The bugs listed here must be resolved before this bug can be resolved."
      class="field_help_link"
  >Depends on:</a>

</th>

  <td>
    <span id="dependson_input_area">
    </span>
    
  </td>
  </tr>
  
  <tr><th class="field_label "
    id="field_label_blocked">


  <a 
      title="This bug must be resolved before the bugs listed in this field can be resolved."
      class="field_help_link"
  >Blocks:</a>

</th>

  <td>
    <span id="blocked_input_area">
    </span>
    
  </td>
  </tr>
        </table>
      </td>
      <td>
        <div class="bz_column_spacer">&nbsp;</div>
      </td>
      
      <td id="bz_show_bug_column_2" class="bz_show_bug_column">
        <table cellpadding="3" cellspacing="1">
        <tr>
    <th class="field_label">
      Reported:
    </th>
    <td>2015-01-21 20:09 CST by <span class="vcard"><span class="fn">Glen MacDonald</span>
</span>
    </td>
  </tr>
  
  <tr>
    <th class="field_label">
      Modified:
    </th>
    <td>2015-02-18 12:20 CST 
    </td>
  
  </tr>
         <tr>
      <th class="field_label">
        <label for="newcc" accesskey="a">CC List:</label>
      </th>
      <td>3 
          users
          <span id="cc_edit_area_showhide_container" class="bz_default_hidden">
            (<a href="#" id="cc_edit_area_showhide">show</a>)
          </span>
        <div id="cc_edit_area">
          <br>
            <select id="cc" multiple="multiple" size="5">
                <option value="ctrueden">ctrueden</option>
                <option value="glenmac">glenmac</option>
                <option value="wsr">wsr</option>
            </select>
        </div>
          
      </td>
    </tr>
         <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
<tr><th class="field_label "
    id="field_label_see_also">


  <a 
      title="This allows you to refer to bugs in other installations. You can enter a URL to a bug in the 'Add Bug URLs' field to note that that bug is related to this one. You can enter multiple URLs at once by separating them with a comma. You should normally use this field to refer to bugs in other installations. For bugs in this installation, it is better to use the Depends on and Blocks fields."
      class="field_help_link"
  >See Also:</a>

</th>
  <td class="field_value "
      id="field_container_see_also" ></td>
    </tr> 
         
         <tr>
    <td colspan="2" class="bz_section_spacer"></td>
  </tr>
         
                

        </table>
      </td>
    </tr>
    <tr>
      <td colspan="3">
          <hr id="bz_top_half_spacer">
      </td>
    </tr>
  </table>

  <table id="bz_big_form_parts" cellspacing="0" cellpadding="0"><tr>
  <td>

    



  </td>
  <td>
  </td>
  </tr></table>

  
  <div id="comments">






<!-- This auto-sizes the comments and positions the collapse/expand links 
     to the right. -->
<table class="bz_comment_table" cellpadding="0" cellspacing="0"><tr>
<td>
<div id="c0" class="bz_comment bz_first_comment">

      <div class="bz_first_comment_head">



        <span class="bz_comment_number">
          <a 
             href="#c0">Description</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Glen MacDonald</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2015-01-21 20:09:59 CST
        </span>
      </div>



<pre class="bz_comment_text" >Montages are created by making a blank stack and using the Stack Inserter to add stacks. Each stack is closed before opening the next component stack. I can observe tht the stacks are closing.  the montages range from 2.5 to 9 Gb in size.  Component stacks are 200-300 Mb in size.  With 12 Gb allocated to Fiji, I keep running out of memory.  If the next blank montage exceeds remaining memory I get a formal out of memory error.  If the blank montage can be created, then Fiji will stitch until one of the stacks exceeds the available memory then stop with a message to the log window.  the only solution is to quit Fiji.  calls to the garbage collector do not help.   SciFio is not being used. IJ2 Data structure has no effect.  Is this a bug or is there a workaround?
thanks, Glen

Information about your version of Java:

  os.arch =&gt; x86_64
  os.name =&gt; Mac OS X
  os.version =&gt; 10.9.5
  java.version =&gt; 1.6.0_65
  java.vendor =&gt; Apple Inc.
  java.runtime.name =&gt; Java(TM) SE Runtime Environment
  java.runtime.version =&gt; 1.6.0_65-b14-462-11M4609
  java.vm.name =&gt; Java HotSpot(TM) 64-Bit Server VM
  java.vm.version =&gt; 20.65-b04-462
  java.vm.vendor =&gt; Apple Inc.
  java.vm.info =&gt; mixed mode
  java.awt.graphicsenv =&gt; apple.awt.CGraphicsEnvironment
  java.specification.name =&gt; Java Platform API Specification
  java.specification.version =&gt; 1.6
  sun.cpu.endian =&gt; little
  sun.desktop =&gt; null
  file.separator =&gt; /

The up-to-date check says: CHECK_TURNED_OFF

Information relevant to JAVA_HOME related problems:

  JAVA_HOME is set to: null
  imagej.dir =&gt; /Applications/Fiji.app

Information about the version of each plugin:

Activated update sites:
ImageJ: <a href="http://update.imagej.net/">http://update.imagej.net/</a> (last check:20150116081452)
Fiji: <a href="http://fiji.sc/update/">http://fiji.sc/update/</a> (last check:20150116084028)
3D ImageJ Suite: <a href="http://sites.imagej.net/Tboudier/">http://sites.imagej.net/Tboudier/</a> (last check:20141207235245)
Bio-Formats: <a href="http://sites.imagej.net/Bio-Formats/">http://sites.imagej.net/Bio-Formats/</a> (last check:20150114182640)
Biomedgroup: <a href="http://sites.imagej.net/Biomedgroup/">http://sites.imagej.net/Biomedgroup/</a> (last check:20141216080640)
BioVoxxel: <a href="http://sites.imagej.net/BioVoxxel/">http://sites.imagej.net/BioVoxxel/</a> (last check:20150112120702)
CMCI-EMBL: <a href="http://sites.imagej.net/Miura/">http://sites.imagej.net/Miura/</a> (last check:20140718070940)
FFMPEG: <a href="http://fiji.sc/~schindelin/ffmpeg-plugins/">http://fiji.sc/~schindelin/ffmpeg-plugins/</a> (last check:20130606082449)
IMCF Uni Basel: <a href="http://sites.imagej.net/UniBas-IMCF/">http://sites.imagej.net/UniBas-IMCF/</a> (last check:20141116104718)
Morphology: <a href="http://sites.imagej.net/Landini/">http://sites.imagej.net/Landini/</a> (last check:20140723075558)
MOSAIC ToolSuite: <a href="http://mosaic.mpi-cbg.de/Downloads/update/Fiji/MosaicToolsuite/">http://mosaic.mpi-cbg.de/Downloads/update/Fiji/MosaicToolsuite/</a> (last check:20150120074915)
NucleusJ: <a href="http://sites.imagej.net/PouletAxel/">http://sites.imagej.net/PouletAxel/</a> (last check:20141101023602)
Stowers: <a href="http://research.stowers.org/imagejplugins/updates/">http://research.stowers.org/imagejplugins/updates/</a> (last check:20150106143220)
WormSizer: <a href="http://sites.imagej.net/Bradtmoore/">http://sites.imagej.net/Bradtmoore/</a> (last check:20140504092939)

Files not up-to-date:
  2418366b (MODIFIED) 20150121161955 Contents/Info.plist
  1ad3be0d (LOCAL_ONLY) 20141119213514 jars/jpedalSTD.jar
  07f4044a (LOCAL_ONLY) 20140612110153 macros/CLAHE stack.ijm
  dc3f77db (LOCAL_ONLY) 20140612103947 macros/Float stack.ijm
  37aecc8a (LOCAL_ONLY) 20141007123738 macros/Old versions/FVstack inserter_.ijm
  a6b787e7 (LOCAL_ONLY) 20140625172146 macros/Old versions/Stereology_grid2_4.ijm
  65fe498d (LOCAL_ONLY) 20120730154750 macros/Old versions/drift3b.ijm
  07eaea1d (LOCAL_ONLY) 20120821154843 macros/Old versions/waterjet2.ijm
  9d962521 (LOCAL_ONLY) 20120618120603 macros/PIMP_2f-3ivariant.ijm
  b69e6838 (LOCAL_ONLY) 20120622105927 macros/PIMP_2g.ijm
  eb509ed0 (LOCAL_ONLY) 20120717095350 macros/PIMP_2gbgsubtraction.ijm
  e56187b3 (LOCAL_ONLY) 20120710174431 macros/PIMP_2gtests.ijm
  41baa729 (LOCAL_ONLY) 20120717105146 macros/PIMP_2h.ijm
  c46ef207 (LOCAL_ONLY) 20120717110725 macros/PIMP_2i.ijm
  22596c68 (LOCAL_ONLY) 20120615161654 macros/PIMP_finalGHMarrays2e3DguassThold.ijm
  7fb3cc04 (LOCAL_ONLY) 20120615161647 macros/PIMP_finalGHMarrays2e3Dguassian.ijm
  87255328 (LOCAL_ONLY) 20140206150200 macros/delete2slices.ijm
  fd6a1c44 (LOCAL_ONLY) 20141203103226 macros/print properties_.ijm
  9aafb25c (LOCAL_ONLY) 20141203114918 macros/random numbers_.ijm
  9f59bd3b (LOCAL_ONLY) 20141105091214 macros/tools/Calibration_Menu.ijm
  bf41d3c0 (LOCAL_ONLY) 20141105091215 macros/tools/List_Folder_Menu.ijm
  8364abb4 (LOCAL_ONLY) 20141105091214 macros/tools/Segment_Profile.ijm
  f3cfc0b6 (LOCAL_ONLY) 20141105091214 macros/tools/Shortcuts_Menu.ijm
  74f75823 (LOCAL_ONLY) 20120719100435 macros/toolsets/3DClusterAnalysis.ijm
  5e7a3919 (LOCAL_ONLY) 20140815160318 macros/toolsets/Analyze Utricles-BioFormats.ijm
  0fe955a3 (LOCAL_ONLY) 20120305144333 macros/toolsets/Andrew Macro4b.ijm
  6cc0aae2 (LOCAL_ONLY) 20110901171448 macros/toolsets/Arminda timelapse macro 3.8b.ijm
  f4074bbb (LOCAL_ONLY) 20120702084321 macros/toolsets/BPCounting3g.ijm
  3f9a11ae (LOCAL_ONLY) 20150116170843 macros/toolsets/Convert to Unsigned_.ijm
  8bf6c467 (LOCAL_ONLY) 20141007164319 macros/toolsets/FV Optical Disector.ijm
  48c586d9 (LOCAL_ONLY) 20141212165342 macros/toolsets/FV-OME_Montage_1.ijm
  6ec9c1fd (LOCAL_ONLY) 20150114153429 macros/toolsets/FV_Montage_ACDC3.ijm
  8e86396d (LOCAL_ONLY) 20131018145317 macros/toolsets/FWHM.ijm
  2fe75fec (LOCAL_ONLY) 20131107171559 macros/toolsets/FWHM3.ijm
  9e64fe4d (LOCAL_ONLY) 20141104120029 macros/toolsets/FWHMJayb.ijm
  750b79cc (LOCAL_ONLY) 20141204150658 macros/toolsets/FWHMJayc.ijm
  c68a09eb (LOCAL_ONLY) 20120911102147 macros/toolsets/Fill ROI Macro.ijm
  edbc43b2 (LOCAL_ONLY) 20141205145444 macros/toolsets/Find and List Files by Name_.ijm
  ead280e3 (LOCAL_ONLY) 20120808153016 macros/toolsets/GTTR Segmentation3.ijm
  77158612 (LOCAL_ONLY) 20150102131424 macros/toolsets/Import Channel Order3.98c.ijm
  17d1aba0 (LOCAL_ONLY) 20140404113537 macros/toolsets/Merge HuPro Quadrants_3b.ijm
  9f68e1dd (LOCAL_ONLY) 20150109143800 macros/toolsets/Multi-Line Intensity Plot.ijm
  01179b26 (LOCAL_ONLY) 20120913130241 macros/toolsets/Multiply.ijm
  6fabf894 (LOCAL_ONLY) 20141114145758 macros/toolsets/NewSlidebook2_.ijm
  680ee77a (LOCAL_ONLY) 20141111130926 macros/toolsets/NewSlidebook_.ijm
  4651471a (LOCAL_ONLY) 20121116153429 macros/toolsets/PIMP_3_Batch.ijm
  0c5c4a4c (LOCAL_ONLY) 20121116153510 macros/toolsets/PIMP_3_Single file.ijm
  4b5104ee (LOCAL_ONLY) 20120627100227 macros/toolsets/Placenta macro3.ijm
  1e56302a (LOCAL_ONLY) 20141118152407 macros/toolsets/RAMSlidebook2_.ijm
  0c256129 (LOCAL_ONLY) 20141105091214 macros/toolsets/ROI Manager Tools.ijm
  ca90b65b (LOCAL_ONLY) 20141002163033 macros/toolsets/Scaled sampling grid.ijm
  24c3ebb4 (LOCAL_ONLY) 20131218123203 macros/toolsets/Scan macro.ijm
  7b436426 (LOCAL_ONLY) 20141107172453 macros/toolsets/Slidebook montage_.ijm
  cb9c4438 (LOCAL_ONLY) 20141104113030 macros/toolsets/Stereology_grid2_6.ijm
  232bca5e (LOCAL_ONLY) 20120910121056 macros/toolsets/Temporal Time Encoder.ijm
  3af0fe66 (LOCAL_ONLY) 20141105091214 macros/toolsets/Toolset Creator.ijm
  3d17a094 (LOCAL_ONLY) 20140115144252 macros/toolsets/Utricle_RGB_merge2_2.ijm
  618286ae (LOCAL_ONLY) 20121115152953 macros/toolsets/batchStackreg.ijm
  e8677e33 (LOCAL_ONLY) 20141028141133 macros/toolsets/ctbp2a macro.ijm
  6cedb193 (LOCAL_ONLY) 20120730162148 macros/toolsets/drift3c.ijm
  fc424882 (LOCAL_ONLY) 20120305133512 macros/toolsets/macro development/Andrew Macro4a.ijm
  0b91930b (LOCAL_ONLY) 20111007164331 macros/toolsets/macro development/Arminda 3.98test.ijm
  07f111f8 (LOCAL_ONLY) 20120620161839 macros/toolsets/macro development/FWHM.ijm
  607b8de2 (LOCAL_ONLY) 20110928161804 macros/toolsets/macro development/Import Channel Order3.98.ijm
  891da2e3 (LOCAL_ONLY) 20110831161129 macros/toolsets/macro development/Import_Channel_Order3.8atlapse.txt
  c1e7d84a (LOCAL_ONLY) 20110831163521 macros/toolsets/macro development/Import_Channel_Order3.8btlapse.txt
  3fedd17e (LOCAL_ONLY) 20110901165057 macros/toolsets/macro development/Import_Channel_Order3.8btlapse.txt.ijm
  6ddde9e7 (LOCAL_ONLY) 20110124183506 macros/toolsets/macro development/Import_Channel_Order3.8f.txt
  76c91a2c (LOCAL_ONLY) 20120529122545 macros/toolsets/macro development/PIMP_final.ijm
  45be256a (LOCAL_ONLY) 20120601113233 macros/toolsets/macro development/PIMP_finalGHMarrays2b.ijm
  de11be1e (LOCAL_ONLY) 20120403145549 macros/toolsets/macro development/Scale CellVizio Tiff stack.ijm
  ee6d3193 (LOCAL_ONLY) 20120221135146 macros/toolsets/macro development/testscale.ijm
  83d10173 (LOCAL_ONLY) 20120712161724 macros/toolsets/plot coordinates.ijm
  d1a3a016 (LOCAL_ONLY) 20120712161713 macros/toolsets/plotresults.ijm
  833e093f (LOCAL_ONLY) 20140926165030 macros/toolsets/testbatchopen.ijm
  c1dcbd92 (LOCAL_ONLY) 20121008113151 macros/toolsets/transition stacks.ijm
  301245dd (LOCAL_ONLY) 20120822090138 macros/toolsets/waterjet2deltaf.ijm
  81fecfd4 (LOCAL_ONLY) 20120822172438 macros/toolsets/waterjet3.ijm
  d054d71f (LOCAL_ONLY) 20120717163446 macros/use copyand restore ROI.ijm
  d5294aaa (LOCAL_ONLY) 20141210131239 plugins/Hill_Shade.class
  fb824711 (MODIFIED) 20141210130824 plugins/Ridge_Detect.jar
  b2afde18 (LOCAL_ONLY) 20141216103055 plugins/cell_counter.jar</pre>
    </div><div id="c1" class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a 
             href="#c1">Comment 1</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Wayne Rasband</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2015-01-21 20:54:40 CST
        </span>
      </div>



<pre class="bz_comment_text" >Could you provide a small test macro that we can use to reproduce this problem? The following macro works as expected. The memory used by the four 512x512x100 temporary stacks it opens (25MB each) is reclaimed.

  newImage(&quot;Montage&quot;, &quot;8-bit ramp&quot;, 1024, 1024, 100);
  x=0; y=0
  for (i=0; i&lt;4; i++) {
    newImage(&quot;Stack&quot;, &quot;8-bit ramp&quot;, 512, 512, 100);
    run(&quot;Insert...&quot;, &quot;source=Stack destination=Montage x=&amp;x y=&amp;y&quot;);
    close();
    x += 512;
    if (x==1024) {
       x = 0;
       y += 512;
    }
  }
  setBatchMode(false);</pre>
    </div><div id="c2" class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a 
             href="#c2">Comment 2</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Glen MacDonald</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2015-02-06 12:21:07 CST
        </span>
      </div>



<pre class="bz_comment_text" >Hi Wayne,
First time replying on BugZilla, so hoping this is correct.
Here are macros that [1] generates 4 stacks then [2] opens files, creates a montage and also prints out memory usage at each step.  I’ve tried with various stack sizes. Behavior is not entirely consistent on any computer, sometimes all memory is released when the macro finishes with small stacks. But never with large stacks.  
When the finished montage does release memory,I was surprised that the memory for each component stack is not released when that stack is closed, only when the macro exits.  This means the maximum size of a montage is 1/2 the available memory.   I ran the debugger bug but saw nothing intelligible to me.  


macro &quot;make stacks [1]&quot;{
	target=getDirectory(&quot;Source&quot;);
	for (s=0;s&lt;4;s++){
		newImage(&quot;HyperStack&quot;, &quot;16-bit ramp&quot;, 1024, 1024, 3,100,1);
		saveAs(&quot;Tiff&quot;,target+&quot;Stack000&quot;+s);
	}
}

 macro &quot;make montages [2]&quot;{
 	dir=getDirectory(&quot;Source&quot;);
 	dirList=getFileList(dir);
 	fList=newArray(0);
 	print(&quot;Start Macro- Free memory:&quot;,IJ.freeMemory(), &quot;Currently in use:&quot;,IJ.currentMemory());
	newImage(&quot;Hyperstack&quot;, &quot;16-bit composite-mode&quot;, 2048,2048,3,100,1);	
	print(&quot;Create Stack- Free memory:&quot;,IJ.freeMemory(), &quot;Currently in use:&quot;,IJ.currentMemory());
	xx=0;
	yy=0;
	strname=&quot;montage&quot;;
	grayopt=&quot;color_mode=Grayscale view=Hyperstack stack_order=XYCZT&quot;;
	for(i=0;i&lt;dirList.length;i++){
		if(endsWith(dirList[i],&quot;.tif&quot;)||(endsWith(dirList[i],&quot;.tiff&quot;)))
			fList=Array.concat(fList,dirList[i]);
	}	
		for(f=0;f&lt;fList.length;f++){
			fpath=dir+fList[f];
		//showStatus(&quot;Opening stack&quot;);
		run(&quot;Bio-Formats Windowless Importer&quot;, &quot;open=[fpath] [grayopt]&quot;);
		rename(&quot;Source&quot;);
		run(&quot;Insert...&quot;, &quot;source=Source destination=Hyperstack x=xx y=yy&quot;);
		run(&quot;Close&quot;);
			print(&quot;Add Stack &quot;+f+&quot;:&quot;,IJ.freeMemory(), &quot;Currently in use:&quot;,IJ.currentMemory());
		xx+=1024;
  		if (xx==2048) {
     		xx = 0;
      		yy += 1024;
   	}
	}
	run(&quot;Close&quot;);
	//print(&quot;Free memory:&quot;,IJ.freeMemory(), &quot;Currently in use:&quot;,IJ.currentMemory());
}



regards

Glen MacDonald
	Core for Communication Research
Virginia Merrill Bloedel Hearing Research Center
	Cellular Morphology Core
Center on Human Development and Disability
Box 357923
University of Washington
Seattle, WA 98195-7923  USA
(206) 616-4156
<a href="mailto:glenmac&#64;uw.edu">glenmac&#64;uw.edu</a>







On Jan 21, 2015, at 6:54 PM, <a href="mailto:bugzilla&#64;fiji.sc">bugzilla&#64;fiji.sc</a> wrote:

Wayne Rasband changed <a class="bz_bug_link 
          bz_status_RESOLVED  bz_closed"
   title="RESOLVED FIXED - Mac OS out of memory"
   href="990.html">bug 990</a> 
What	Removed	Added
CC	  	<a href="mailto:wsr&#64;nih.gov">wsr&#64;nih.gov</a>

<a href="#c1">Comment # 1</a> on <a class="bz_bug_link 
          bz_status_RESOLVED  bz_closed"
   title="RESOLVED FIXED - Mac OS out of memory"
   href="990.html">bug 990</a> from Wayne Rasband
Could you provide a small test macro that we can use to reproduce this problem?
The following macro works as expected. The memory used by the four 512x512x100
temporary stacks it opens (25MB each) is reclaimed.

 newImage(&quot;Montage&quot;, &quot;8-bit ramp&quot;, 1024, 1024, 100);
 x=0; y=0
 for (i=0; i&lt;4; i++) {
   newImage(&quot;Stack&quot;, &quot;8-bit ramp&quot;, 512, 512, 100);
   run(&quot;Insert...&quot;, &quot;source=Stack destination=Montage x=&amp;x y=&amp;y&quot;);
   close();
   x += 512;
   if (x==1024) {
      x = 0;
      y += 512;
   }
 }
 setBatchMode(false);


You are receiving this mail because:
	• You are on the CC list for the bug.
	• You reported the bug.</pre>
    </div><div id="c3" class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a 
             href="#c3">Comment 3</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Wayne Rasband</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2015-02-08 20:39:47 CST
        </span>
      </div>



<pre class="bz_comment_text" >Hi Glen,

I am not able to consistently reproduce this problem. Yesterday, when testing your macro, I noticed that sometimes not all memory was reclaimed after the macro finished and I ran the garbage collector by clicking on the status bar or &quot;Memory&quot; window. Today, however, the memory is always reclaimed after running the macro and clicking in the &quot;Memory&quot; window.

The following version of your macro displays the &quot;Memory&quot; window and creates 10 montages. The &quot;Make Montage&quot; macro is first so you can run it by clicking on &quot;Run&quot; in Fiji's script editor. Watch the &quot;Memory&quot; window as the macro runs and you will see that memory is reclaimed as needed or you click in the &quot;Memory&quot; window. This version of the macro also fixes a few problems with passing variables and it removes the 'grayopt' string, which was not seen by the Insert command because it was not passed correctly.


  macro &quot;Make Montage [1]&quot; {
     dir=getDirectory(&quot;Source&quot;);
     n = 10; 
     list=getFileList(dir);
      for (i=0; i&lt;n; i++) {
        montage = &quot;Montage-&quot;+(i+1)+&quot;/&quot;+n;
        newImage(montage, &quot;16-bit composite-mode&quot;, 2048,2048,3,100,1);    
        doCommand(&quot;Monitor Memory...&quot;);
        x=0; y=0;
        for (f=0; f&lt;list.length; f++) {
           fpath=dir+list[f];
           //open(fpath);
           run(&quot;Bio-Formats Windowless Importer&quot;, &quot;open=&amp;fpath&quot;);
           rename(&quot;Source&quot;);
           run(&quot;Insert...&quot;, &quot;source=Source destination=&amp;montage x=&amp;x y=&amp;y&quot;);
           close;
           x += 1024;
           if (x==2048) {
              x = 0;
              y += 1024;
           }
        }
        close;
     }
  }

  macro &quot;Make Stacks [2]&quot; {
      target=getDirectory(&quot;Choose Directory&quot;);
      newImage(&quot;HyperStack&quot;, &quot;16-bit ramp&quot;, 1024, 1024, 3,100,1);
      for (s=0;s&lt;4;s++)
          saveAs(&quot;Tiff&quot;,target+&quot;Stack000&quot;+s);
  }</pre>
    </div><div id="c4" class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a 
             href="#c4">Comment 4</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Glen MacDonald</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2015-02-13 20:19:51 CST
        </span>
      </div>



<pre class="bz_comment_text" >Hi Wayne,
thanks for the cleanup on the macro. I still have much to learn (or remember). I ran it on 5 Macs, all OS10.9.5, latest Fiji 1.49m RC24, Java 1.60_65. oldest was Early 2009 MacPro, newest was Late 2013 iMac. All gave variable results: sometimes releasing all memory at each interation, sometimes retaining 1,2 or 3 stacks or a montage until the next montage loop, other times releasing nothing on every montage.  I'm not seeing that the garbage collector is doing anything when clicking on status bar or calling from the macro. Behavior is different every time Fiji starts up.  I've read that too many GC calls can result in OOM errors. Could there be Java settings I should investigate?  I've never before had an iterative operation behave like this.  Interestingly, the older 2 macs had more OOM, they are Xeons instead of i5 or i7.  

Regards,
glen</pre>
    </div><div id="c5" class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a 
             href="#c5">Comment 5</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Curtis Rueden</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2015-02-13 21:53:39 CST
        </span>
      </div>



<pre class="bz_comment_text" >Glen, might I suggest trying with Java 7 or Java 8 instead of Java 6? Java 7 fixes many of Java 6's problems.

<a href="http://imagej.net/FAQ#How_do_I_launch_ImageJ_with_a_different_version_of_Java.3F">http://imagej.net/FAQ#How_do_I_launch_ImageJ_with_a_different_version_of_Java.3F</a>

(As an aside: there will soon be a new version of the ImageJ launcher that makes it easier to use Java 7 or 8 on OS X without needing to install Java 6 anymore.)</pre>
    </div><div id="c6" class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a 
             href="#c6">Comment 6</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Wayne Rasband</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2015-02-14 19:16:24 CST
        </span>
      </div>



<pre class="bz_comment_text" >Hi Glen,

You should not expect memory to be released at each iteration or when the macro finishes. The garbage collector will run as needed to reclaim memory and prevent OOM errors. If you are still getting OOM errors, try replacing

   run(&quot;Bio-Formats Windowless Importer&quot;, &quot;open=&amp;fpath&quot;);

with

   open(fpath);</pre>
    </div><div id="c7" class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a 
             href="#c7">Comment 7</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Glen MacDonald</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2015-02-18 11:07:13 CST
        </span>
      </div>



<pre class="bz_comment_text" >Hi Curtis,
Java 1.7.0_75 seems to have resolved the issue.  Good to hear there is a Java selection option in the works.  I was going to inquire on the devel list whether Fiji could check for installed Java versions and provide a checkbox for choosing which ver. to run on restart.  

Its interesting that memory use reported by the memory monitor and IJ.getcurrent memory drops as the size of the test montage is increased.  

Now that Huygens runs under Yosemite, I'm going to start upgrading systems.  

thanks,
Glen</pre>
    </div><div id="c8" class="bz_comment">

      <div class="bz_comment_head">



        <span class="bz_comment_number">
          <a 
             href="#c8">Comment 8</a>
        </span>

        <span class="bz_comment_user">
          <span class="vcard"><span class="fn">Curtis Rueden</span>
</span>
        </span>

        <span class="bz_comment_user_images">
        </span>

        <span class="bz_comment_time">
          2015-02-18 12:20:38 CST
        </span>
      </div>



<pre class="bz_comment_text" >Glad to hear that Java 7 fixes the issue!</pre>
    </div>


  

</td>
<td>
</td>
</tr></table>
  </div>
        



</div>

</body>
</html>
